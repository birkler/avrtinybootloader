<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>USB IR HID Device: bootloader_firmware/usbdrv/usbdrv.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>bootloader_firmware/usbdrv/usbdrv.c File Reference</h1><code>#include &quot;<a class="el" href="bootloader__firmware_2usbdrv_2iarcompat_8h-source.html">iarcompat.h</a>&quot;</code><br>
<code>#include &lt;avr/io.h&gt;</code><br>
<code>#include &lt;avr/pgmspace.h&gt;</code><br>
<code>#include &quot;<a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8h-source.html">usbdrv.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="bootloader__firmware_2usbdrv_2oddebug_8h-source.html">oddebug.h</a>&quot;</code><br>

<p>
<a href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">union &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="unionconverter__t.html">converter_t</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#aa927c92dfe5b14f5b87f5ecabf4c14e">IAR_SECTION</a>(arg)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#55530f24354538975ee7102fb88f123a">__no_init</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#2a36a35f900ede87e7c897bc778065c8">USB_FLG_TX_PACKET</a>&nbsp;&nbsp;&nbsp;(1&lt;&lt;0)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#06db19dbad17d54fc6f3742ab0afba69">USB_FLG_MSGPTR_IS_ROM</a>&nbsp;&nbsp;&nbsp;(1&lt;&lt;6)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#5e3bb8fb87bbde80118c36559bf41bcb">USB_FLG_USE_DEFAULT_RW</a>&nbsp;&nbsp;&nbsp;(1&lt;&lt;7)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#f7c7b7892c3be6693e9107a0b4e1a75e">PRG_RDB</a>(addr)&nbsp;&nbsp;&nbsp;pgm_read_byte(addr)</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__no_init uchar <a class="el" href="usbdrv_2usbdrv_8c.html#50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>[2][USB_BUFSIZE]&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#c05a996e552f0ab23ee75260e66a027d">__attribute__</a> ((section(USB_BUFFER_SECTION)))</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#d3eef923d7e69592f8b3aa3bf983bb92">usbSetInterrupt</a> (uchar *data, uchar len)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#602c14b8f268adeae6896014c9a79909">usbPoll</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#4552b1c9fe142a402c84c15444d3d927">usbInit</a> (void)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">uchar&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#f51ba5254931f6a71985e275305242d7">usbNakBuf</a> [1] = {USBPID_NAK}</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">uchar *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#5f78c8584830588b8c0c8f2a27772f8e">usbMsgPtr</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="55530f24354538975ee7102fb88f123a"></a><!-- doxytag: member="usbdrv.c::__no_init" ref="55530f24354538975ee7102fb88f123a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define __no_init          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00027">27</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="aa927c92dfe5b14f5b87f5ecabf4c14e"></a><!-- doxytag: member="usbdrv.c::IAR_SECTION" ref="aa927c92dfe5b14f5b87f5ecabf4c14e" args="(arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IAR_SECTION          </td>
          <td>(</td>
          <td class="paramtype">arg&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00026">26</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="f7c7b7892c3be6693e9107a0b4e1a75e"></a><!-- doxytag: member="usbdrv.c::PRG_RDB" ref="f7c7b7892c3be6693e9107a0b4e1a75e" args="(addr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PRG_RDB          </td>
          <td>(</td>
          <td class="paramtype">addr&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;pgm_read_byte(addr)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00175">175</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="06db19dbad17d54fc6f3742ab0afba69"></a><!-- doxytag: member="usbdrv.c::USB_FLG_MSGPTR_IS_ROM" ref="06db19dbad17d54fc6f3742ab0afba69" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define USB_FLG_MSGPTR_IS_ROM&nbsp;&nbsp;&nbsp;(1&lt;&lt;6)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00064">64</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="2a36a35f900ede87e7c897bc778065c8"></a><!-- doxytag: member="usbdrv.c::USB_FLG_TX_PACKET" ref="2a36a35f900ede87e7c897bc778065c8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define USB_FLG_TX_PACKET&nbsp;&nbsp;&nbsp;(1&lt;&lt;0)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00062">62</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="5e3bb8fb87bbde80118c36559bf41bcb"></a><!-- doxytag: member="usbdrv.c::USB_FLG_USE_DEFAULT_RW" ref="5e3bb8fb87bbde80118c36559bf41bcb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define USB_FLG_USE_DEFAULT_RW&nbsp;&nbsp;&nbsp;(1&lt;&lt;7)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00065">65</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="c05a996e552f0ab23ee75260e66a027d"></a><!-- doxytag: member="usbdrv.c::__attribute__" ref="c05a996e552f0ab23ee75260e66a027d" args="((section(USB_BUFFER_SECTION)))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__no_init uchar <a class="el" href="usbdrv_2usbdrv_8c.html#50d7f851abf281804143e797d0bfbf04">usbRxBuf</a> [2][USB_BUFSIZE] __attribute__           </td>
          <td>(</td>
          <td class="paramtype">(section(USB_BUFFER_SECTION))&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00037">37</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00037"></a>00037                                                                                                                                         : PID, 8 bytes data, 2 bytes CRC */
<a name="l00038"></a>00038 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a>;      <span class="comment">/* assigned during enumeration, defaults to 0 */</span>
<a name="l00039"></a>00039 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#b9c08d1850db1e4d9feea687bc129425">usbNewDeviceAddr</a>;   <span class="comment">/* device ID which should be set after status phase */</span>
<a name="l00040"></a>00040 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#a43502fd98afab29fcd5115c1f2c4067">usbConfiguration</a>;   <span class="comment">/* currently selected configuration. Administered by driver, but not used */</span>
<a name="l00041"></a>00041 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       usbInputBuf;        <span class="comment">/* ptr to raw buffer used for receiving */</span>
<a name="l00042"></a>00042 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       usbAppBuf;          <span class="comment">/* ptr to raw buffer passed to app for processing */</span>
<a name="l00043"></a>00043 <span class="keyword">volatile</span> <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#f2cbb84f982ea77dfbb738af3a027591">schar</a> <a class="code" href="usbdrv_2usbdrv_8c.html#3d8dd46333d7cf2258067c00428efc47">usbRxLen</a>;        <span class="comment">/* = 0; number of bytes in usbAppBuf; 0 means free */</span>
<a name="l00044"></a>00044 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#e302a61abfeb0784f42a903dd44aad1e">usbCurrentTok</a>;      <span class="comment">/* last token received */</span>
<a name="l00045"></a>00045 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#e2a9422baba7da8914129e0784ab2c05">usbRxToken</a>;         <span class="comment">/* token for data we received */</span>
<a name="l00046"></a>00046 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#5d017abeeddd393d4abda00257c73930">usbMsgLen</a> = 0xff;   <span class="comment">/* remaining number of bytes, no msg to send if -1 (see usbMsgPtr) */</span>
<a name="l00047"></a>00047 <span class="keyword">volatile</span> <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#f2cbb84f982ea77dfbb738af3a027591">schar</a> <a class="code" href="usbdrv_2usbdrv_8c.html#6d1c6f67a95541d4f45d26dd80e07693">usbTxLen</a> = -1;   <span class="comment">/* number of bytes to transmit with next IN token */</span>
<a name="l00048"></a>00048 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#2e8d07fcad8aa462b6a1f51e7968f3cb">usbTxBuf</a>[<a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#1c541dbab181ea7bd3da61b892430988">USB_BUFSIZE</a>];<span class="comment">/* data to transmit with next IN, free if usbTxLen == -1 */</span>
<a name="l00049"></a>00049 <span class="preprocessor">#if USB_CFG_HAVE_INTRIN_ENDPOINT</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="comment">/* uchar       usbRxEndp;          endpoint which was addressed (1 bit in MSB) [not impl] */</span>
<a name="l00051"></a>00051 <span class="keyword">volatile</span> <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#f2cbb84f982ea77dfbb738af3a027591">schar</a> <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#2e90de9a02954cab2f72d0f509bc4714">usbTxLen1</a> = -1;  <span class="comment">/* TX count for endpoint 1 */</span>
<a name="l00052"></a>00052 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       <a class="code" href="usbdrv_2usbdrv_8c.html#92ad467856cc7e0efeafcda41671ea75">usbTxBuf1</a>[<a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#1c541dbab181ea7bd3da61b892430988">USB_BUFSIZE</a>];<span class="comment">/* TX data for endpoint 1 */</span>
<a name="l00053"></a>00053 <span class="preprocessor">#endif</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       usbAckBuf[1] = {<a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#7f9994b8bc3a4864604aa8041ed90faf">USBPID_ACK</a>};    <span class="comment">/* transmit buffer for ack tokens */</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4552b1c9fe142a402c84c15444d3d927"></a><!-- doxytag: member="usbdrv.c::usbInit" ref="4552b1c9fe142a402c84c15444d3d927" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void usbInit           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00501">501</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

<p>Referenced by <a class="el" href="bootloader__firmware_2main_8c-source.html#l00124">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00502"></a>00502 {
<a name="l00503"></a>00503     usbInputBuf = (<a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>)<a class="code" href="usbdrv_2usbdrv_8c.html#50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>[0];
<a name="l00504"></a>00504     usbAppBuf = (<a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>)<a class="code" href="usbdrv_2usbdrv_8c.html#50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>[1];
<a name="l00505"></a>00505 <span class="preprocessor">#if USB_INTR_CFG_SET != 0</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span>    <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#34cb3bb685c3a6f9c8a63f3a948799b6">USB_INTR_CFG</a> |= <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#ab47b4721030fcf7b773ab33f8e0f1c9">USB_INTR_CFG_SET</a>;
<a name="l00507"></a>00507 <span class="preprocessor">#endif</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span><span class="preprocessor">#if USB_INTR_CFG_CLR != 0</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>    <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#34cb3bb685c3a6f9c8a63f3a948799b6">USB_INTR_CFG</a> &amp;= ~(<a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#aaa3f824f11c2a5e75acb3841063120d">USB_INTR_CFG_CLR</a>);
<a name="l00510"></a>00510 <span class="preprocessor">#endif</span>
<a name="l00511"></a>00511 <span class="preprocessor"></span>    <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#0259fea2ff25be5c0cd58cce07526f84">USB_INTR_ENABLE</a> |= (1 &lt;&lt; <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#3d028bbfd2e3e723bba54a4ac8fd584c">USB_INTR_ENABLE_BIT</a>);
<a name="l00512"></a>00512 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="602c14b8f268adeae6896014c9a79909"></a><!-- doxytag: member="usbdrv.c::usbPoll" ref="602c14b8f268adeae6896014c9a79909" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void usbPoll           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00452">452</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

<p>Referenced by <a class="el" href="bootloader__firmware_2main_8c-source.html#l00124">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00453"></a>00453 {
<a name="l00454"></a>00454 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>   len;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="keywordflow">if</span>((len = <a class="code" href="usbdrv_2usbdrv_8c.html#3d8dd46333d7cf2258067c00428efc47">usbRxLen</a>) &gt; 0){
<a name="l00457"></a>00457 <span class="comment">/* We could check CRC16 here -- but ACK has already been sent anyway. If you</span>
<a name="l00458"></a>00458 <span class="comment"> * need data integrity checks with this driver, check the CRC in your app</span>
<a name="l00459"></a>00459 <span class="comment"> * code and report errors back to the host. Since the ACK was already sent,</span>
<a name="l00460"></a>00460 <span class="comment"> * retries must be handled on application level.</span>
<a name="l00461"></a>00461 <span class="comment"> * unsigned crc = usbCrc16((uchar *)(unsigned)(usbAppBuf + 1), usbRxLen - 3);</span>
<a name="l00462"></a>00462 <span class="comment"> */</span>
<a name="l00463"></a>00463         len -= 3;       <span class="comment">/* remove PID and CRC */</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span>(len &lt; 128){  <span class="comment">/* no overflow */</span>
<a name="l00465"></a>00465             <a class="code" href="unionconverter__t.html">converter_t</a> appBuf;
<a name="l00466"></a>00466             appBuf.<a class="code" href="unionconverter__t.html#6303c2a2b30bdd9ad5dacb62ef19682c">ptr</a> = (<a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a> *)<a class="code" href="usbdrv_2usbdrv_8c.html#50d7f851abf281804143e797d0bfbf04">usbRxBuf</a>;
<a name="l00467"></a>00467             appBuf.<a class="code" href="unionconverter__t.html#f1aa09c318011859f8ff23c5ccd18996">bytes</a>[0] = usbAppBuf;
<a name="l00468"></a>00468             appBuf.<a class="code" href="unionconverter__t.html#f1aa09c318011859f8ff23c5ccd18996">bytes</a>[0]++;
<a name="l00469"></a>00469             usbProcessRx(appBuf.<a class="code" href="unionconverter__t.html#6303c2a2b30bdd9ad5dacb62ef19682c">ptr</a>, len);
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471         <a class="code" href="usbdrv_2usbdrv_8c.html#3d8dd46333d7cf2258067c00428efc47">usbRxLen</a> = 0;   <span class="comment">/* mark rx buffer as available */</span>
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">if</span>(<a class="code" href="usbdrv_2usbdrv_8c.html#5d017abeeddd393d4abda00257c73930">usbMsgLen</a> != 0xff){  <span class="comment">/* transmit data pending? */</span>
<a name="l00474"></a>00474         <span class="keywordflow">if</span>(<a class="code" href="usbdrv_2usbdrv_8c.html#6d1c6f67a95541d4f45d26dd80e07693">usbTxLen</a> &lt; 0)    <span class="comment">/* transmit system idle */</span>
<a name="l00475"></a>00475             usbBuildTxBlock();
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477     <span class="keywordflow">if</span>(isNotSE0()){ <span class="comment">/* SE0 state */</span>
<a name="l00478"></a>00478         usbIsReset = 0;
<a name="l00479"></a>00479     }<span class="keywordflow">else</span>{
<a name="l00480"></a>00480         <span class="comment">/* check whether SE0 lasts for more than 2.5us (3.75 bit times) */</span>
<a name="l00481"></a>00481         <span class="keywordflow">if</span>(!usbIsReset){
<a name="l00482"></a>00482             <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a> i;
<a name="l00483"></a>00483             <span class="keywordflow">for</span>(i=100;i;i--){
<a name="l00484"></a>00484                 <span class="keywordflow">if</span>(isNotSE0())
<a name="l00485"></a>00485                     <span class="keywordflow">goto</span> notUsbReset;
<a name="l00486"></a>00486             }
<a name="l00487"></a>00487             usbIsReset = 1;
<a name="l00488"></a>00488             <a class="code" href="usbdrv_2usbdrv_8c.html#b9c08d1850db1e4d9feea687bc129425">usbNewDeviceAddr</a> = 0;
<a name="l00489"></a>00489             <a class="code" href="usbdrv_2usbdrv_8c.html#3f91a04b325ad5232d270839891e5856">usbDeviceAddr</a> = 0;
<a name="l00490"></a>00490 <span class="preprocessor">#if USB_CFG_IMPLEMENT_HALT</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>            usbHalted1 = 0;
<a name="l00492"></a>00492 <span class="preprocessor">#endif</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>            <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#1b3ae5f24b3863d451c3648fa2ff57be">DBG1</a>(0xff, 0, 0);
<a name="l00494"></a>00494 notUsbReset:;
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="d3eef923d7e69592f8b3aa3bf983bb92"></a><!-- doxytag: member="usbdrv.c::usbSetInterrupt" ref="d3eef923d7e69592f8b3aa3bf983bb92" args="(uchar *data, uchar len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void usbSetInterrupt           </td>
          <td>(</td>
          <td class="paramtype">uchar *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uchar&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00196">196</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00466">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00197"></a>00197 {
<a name="l00198"></a>00198 <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#a8ddf20cdd716b652e76e23e5e700893">uchar</a>       *p, i;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="preprocessor">#if USB_CFG_IMPLEMENT_HALT</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(usbHalted1)
<a name="l00202"></a>00202         <span class="keywordflow">return</span>;
<a name="l00203"></a>00203 <span class="preprocessor">#endif</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(len &gt; 8) <span class="comment">/* interrupt transfers are limited to 8 bytes */</span>
<a name="l00205"></a>00205         len = 8;
<a name="l00206"></a>00206     i = <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#62e5930e01b6235dd17be080135f1546">USBPID_DATA1</a>;
<a name="l00207"></a>00207     <span class="keywordflow">if</span>(usbTxPacketCnt1 &amp; 1)
<a name="l00208"></a>00208         i = <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#ddf02692d5a80756e8edfa12f1fb50c6">USBPID_DATA0</a>;
<a name="l00209"></a>00209     <span class="keywordflow">if</span>(<a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#2e90de9a02954cab2f72d0f509bc4714">usbTxLen1</a> &lt; 0){      <span class="comment">/* packet buffer was empty */</span>
<a name="l00210"></a>00210         usbTxPacketCnt1++;
<a name="l00211"></a>00211     }<span class="keywordflow">else</span>{
<a name="l00212"></a>00212         <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#2e90de9a02954cab2f72d0f509bc4714">usbTxLen1</a> = -1;     <span class="comment">/* avoid sending incomplete interrupt data */</span>
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     p = <a class="code" href="usbdrv_2usbdrv_8c.html#92ad467856cc7e0efeafcda41671ea75">usbTxBuf1</a>;
<a name="l00215"></a>00215     *p++ = i;
<a name="l00216"></a>00216     <span class="keywordflow">for</span>(i=len;i--;)
<a name="l00217"></a>00217         *p++ = *data++;
<a name="l00218"></a>00218     <a class="code" href="usbdrv_2usbdrv_8h.html#96a513e4c0943ba6bd42aa1289874340">usbCrc16Append</a>(&amp;<a class="code" href="usbdrv_2usbdrv_8c.html#92ad467856cc7e0efeafcda41671ea75">usbTxBuf1</a>[1], len);
<a name="l00219"></a>00219     <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#2e90de9a02954cab2f72d0f509bc4714">usbTxLen1</a> = len + 4;    <span class="comment">/* len must be given including sync byte */</span>
<a name="l00220"></a>00220 <span class="preprocessor">#if DEBUG_LEVEL &gt; 1</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>    <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#6c91367860ab33a44869e241022d5b0f">DBG2</a>(0x21, <a class="code" href="usbdrv_2usbdrv_8c.html#92ad467856cc7e0efeafcda41671ea75">usbTxBuf1</a>, <a class="code" href="bootloader__firmware_2usbdrv_2usbdrv_8h.html#2e90de9a02954cab2f72d0f509bc4714">usbTxLen1</a>-1);
<a name="l00222"></a>00222 <span class="preprocessor">#else</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>    <a class="code" href="bootloader__firmware_2usbdrv_2oddebug_8h.html#1b3ae5f24b3863d451c3648fa2ff57be">DBG1</a>(0x21, <a class="code" href="usbdrv_2usbdrv_8c.html#92ad467856cc7e0efeafcda41671ea75">usbTxBuf1</a> + 1, 2);
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="5f78c8584830588b8c0c8f2a27772f8e"></a><!-- doxytag: member="usbdrv.c::usbMsgPtr" ref="5f78c8584830588b8c0c8f2a27772f8e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uchar* <a class="el" href="usbdrv_2usbdrv_8h.html#5f78c8584830588b8c0c8f2a27772f8e">usbMsgPtr</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00058">58</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

<p>Referenced by <a class="el" href="bootloader__firmware_2main_8c-source.html#l00055">usbFunctionSetup()</a>.</p>

</div>
</div><p>
<a class="anchor" name="f51ba5254931f6a71985e275305242d7"></a><!-- doxytag: member="usbdrv.c::usbNakBuf" ref="f51ba5254931f6a71985e275305242d7" args="[1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uchar <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c.html#f51ba5254931f6a71985e275305242d7">usbNakBuf</a>[1] = {USBPID_NAK}          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html#l00055">55</a> of file <a class="el" href="bootloader__firmware_2usbdrv_2usbdrv_8c-source.html">usbdrv.c</a>.</p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 30 15:43:34 2009 for USB IR HID Device by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>

<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>USB IR HID Device: Software</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="software">Software </a></h1><p>Uses the firmware only USB low speed driver from <a href="http://obdev.at.">http://obdev.at.</a> The USB device is configured as a Remote Control HID device.</p>
<h2><a class="anchor" id="tips">
Tips about HID development</a></h2>
<p>General tips about HID development:</p>
<p>1. HID device class is cached by Windows; change USB_CFG_DEVICE_ID if you change USAGE_PAGE class to another. It took me several weeks to find this info. I copied the use page for the remote but it never work until I changed the USB_CFG_DEVICE_ID to another number so that the device was rediscovered by Windows.</p>
<p>2. Added <a class="el" href="usbconfig_8h.html">usbconfig.h</a> manually to the dependencies in the make file to all .o files. WinAVR .d files doesn't seem to work for subdirs</p>
<p>Ir is received by ICP interrupt: </p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#ifndef IRRX_H_</span>
<span class="preprocessor"></span><span class="preprocessor">#define IRRX_H_</span>
<span class="preprocessor"></span>

<span class="preprocessor">#include &lt;inttypes.h&gt;</span>

<span class="comment">// ***********************</span>
<span class="comment">// * External API</span>
<span class="comment">// ***********************</span>

<span class="keyword">typedef</span> uint16_t <a class="code" href="irrx_8h.html#a61660383bded461be19a268349e08fce">irrx_code_t</a>;


<span class="preprocessor">#define IRRX_NO_CODE (0)</span>
<span class="preprocessor"></span>

irrx_code_t <a class="code" href="irrx_8h.html#aefd7d3a37ea0c9c112bbb819045fcea4">irrx_getcode</a>(<span class="keywordtype">void</span>);



<span class="keywordtype">void</span> <a class="code" href="irrx_8h.html#a67846545c3fb744f6106295133d44586">irrx_init</a>(<span class="keywordtype">void</span>);


<span class="keywordtype">void</span> <a class="code" href="irrx_8h.html#acefc681e50139ef6fecefc69f99644d8">irrx_power_on</a>(<span class="keywordtype">void</span>);


<span class="keywordtype">void</span> <a class="code" href="irrx_8h.html#a4ff99c843584f89c5f5d78be97a8dff7">irrx_power_off</a>(<span class="keywordtype">void</span>);





<span class="preprocessor">#endif </span><span class="comment">/*IRRX_H_*/</span>
</pre></div><p>Main loop translated the ir codes received and handles the main USB look: </p>
<div class="fragment"><pre class="fragment">
<span class="comment">/*</span>
<span class="comment"> *  _   _ ____  ____    ___        ____                      _</span>
<span class="comment"> * | | | / ___|| __ )  |_ _|_ __  |  _ \ ___ _ __ ___   ___ | |_ ___</span>
<span class="comment"> * | | | \___ \|  _ \   | || &#39;__| | |_) / _ \ &#39;_ ` _ \ / _ \| __/ _ \</span>
<span class="comment"> * | |_| |___) | |_) |  | || |    |  _ &lt;  __/ | | | | | (_) | ||  __/</span>
<span class="comment"> *  \___/|____/|____/  |___|_|    |_| \_\___|_| |_| |_|\___/ \__\___|</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright 2007 Jorgen Birkler</span>
<span class="comment"> * jorgen.birkler)a(gmail.com</span>
<span class="comment"> * USB HID device for IR receiver</span>
<span class="comment"> * License: GNU GPL v2 (see License.txt) or proprietary (contact author)</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span>
<span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>
<span class="preprocessor">#include &lt;avr/eeprom.h&gt;</span>
<span class="preprocessor">#include &lt;avr/wdt.h&gt;</span>

<span class="preprocessor">#include &lt;string.h&gt;</span>

<span class="preprocessor">#include &quot;<a class="code" href="usbdrv_8h.html">usbdrv.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="irrx_8h.html">irrx.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="oddebug_8h.html">oddebug.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="uart__io_8h.html">uart_io.h</a>&quot;</span>

<span class="preprocessor">#define elements_of(array) (sizeof(array) / sizeof(array[0]))</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define LED_RED_CHANGE() PORTB ^= _BV(PB2)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_RED_ON() PORTB |= _BV(PB2)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_RED_OFF() PORTB &amp;= ~_BV(PB2)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_RED_INIT() DDRB |= _BV(PB2) | _BV(PB1);PORTB &amp;= ~_BV(PB1);LED_RED_OFF()</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define LED_GREEN_CHANGE() PORTC ^= _BV(PC3)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_GREEN_ON() PORTC |= _BV(PC3)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_GREEN_OFF() PORTC &amp;= ~_BV(PC3)</span>
<span class="preprocessor"></span><span class="preprocessor">#define LED_GREEN_INIT() PORTC |= _BV(PC3);LED_RED_OFF()</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define SWITCH_PGM_IS_PRESSED() bit_is_clear(PINC,4)</span>
<span class="preprocessor"></span><span class="preprocessor">#define SWITCH_PGM_INIT() DDRC &amp;=~_BV(PC4);PORTC|=_BV(PC4)</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * help macros</span>
<span class="comment"> */</span>
<span class="preprocessor">#define STATIC_ASSERT(expr) extern char static_assert[ (!!(expr))*2 - 1]</span>
<span class="preprocessor"></span>
<span class="keyword">typedef</span> <span class="keyword">struct</span>
{
  uint8_t put;
  uint8_t <span class="keyword">get</span>;
  uint8_t data[128];
} <a class="code" href="structvirtual__keyboard__buffer__t.html">virtual_keyboard_buffer_t</a>;

<span class="keyword">static</span> <span class="keywordtype">int</span> virtual_keyboard_ioputchar(<span class="keywordtype">char</span> c, FILE *stream);

<span class="keyword">static</span> <a class="code" href="structvirtual__keyboard__buffer__t.html">virtual_keyboard_buffer_t</a> virtual_keyboard_buffer =
{ 0, 0,
{ 0 } };

<a class="code" href="main_8c.html#aa7d921cda07f5efb9d08bbd36ee22f1b">STATIC_ASSERT</a>(<span class="keyword">sizeof</span>(virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>) == 128 || <span class="keyword">sizeof</span>(virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>) == 256 || <span class="keyword">sizeof</span>(virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>) == 64);

<span class="keyword">static</span> FILE virtual_keyboard_file_io= FDEV_SETUP_STREAM(virtual_keyboard_ioputchar, NULL, _FDEV_SETUP_WRITE);

<span class="keyword">static</span> <span class="keywordtype">int</span> virtual_keyboard_ioputchar(<span class="keywordtype">char</span> c, FILE *stream)
{
  uint8_t next = (virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#ad7407c6c84a0ad29cd60730c36c33757">put</a> + 1)
      &amp; (<span class="keyword">sizeof</span>(virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>) - 1);
  <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\n&#39;</span>)
  {
    c = <span class="charliteral">&#39;\r&#39;</span>;
  }
  <span class="keywordflow">if</span> (next == virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a>)
  {
    <span class="keywordflow">return</span> 0; <span class="comment">//Full</span>
  }
  virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>[virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#ad7407c6c84a0ad29cd60730c36c33757">put</a>] = c;
  virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#ad7407c6c84a0ad29cd60730c36c33757">put</a> = next;
  <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> virtual_keyboard_buffer_not_empty(<span class="keywordtype">void</span>)
{
  <span class="keywordflow">return</span> (virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#ad7407c6c84a0ad29cd60730c36c33757">put</a> != virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a>);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> virtual_keyboard_iogetchar(<span class="keywordtype">void</span>)
{
  <span class="keywordflow">if</span> (virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#ad7407c6c84a0ad29cd60730c36c33757">put</a> == virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a>)
  {
    <span class="keywordflow">return</span> -1; <span class="comment">//Empty</span>
  }
  <span class="keywordflow">else</span>
  {
    <span class="keywordtype">int</span> c;
    c = virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>[virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a>];
    virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a> = (virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a64485ab4eb946728621f0c37c5ac82cd">get</a> + 1)
        &amp; (<span class="keyword">sizeof</span>(virtual_keyboard_buffer.<a class="code" href="structvirtual__keyboard__buffer__t.html#a538d65ca03fc727dd025aa93aa9faef1">data</a>) - 1);
    <span class="keywordflow">return</span> c;
  }
}

<span class="preprocessor">#define LEFT_SHIFT_BIT 0x80</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define USB_HID_KEY_a_A 0x04</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_0 0x27</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_1 0x1E</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_RETURN 0x28</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_SPACEBAR 0x2C</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_DOT 0x37</span>
<span class="preprocessor"></span><span class="preprocessor">#define USB_HID_KEY_COMMA 0x36</span>
<span class="preprocessor"></span>


<span class="keyword">static</span> uint8_t virtual_keyboard_translate_to_hid(<span class="keywordtype">int</span> c)
{
  <span class="keywordflow">if</span> (c &lt;= 0)
  {
    <span class="keywordflow">return</span> 0;
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;a&#39;</span> &lt;= c &amp;&amp; c &lt;= <span class="charliteral">&#39;z&#39;</span>)
  {
    <span class="keywordflow">return</span> (c - <span class="charliteral">&#39;a&#39;</span> + <a class="code" href="main_8c.html#a4946baeabe139cefb48abe86ae00bda4">USB_HID_KEY_a_A</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;A&#39;</span> &lt;= c &amp;&amp; c &lt;= <span class="charliteral">&#39;Z&#39;</span>)
  {
    <span class="keywordflow">return</span> (c - <span class="charliteral">&#39;A&#39;</span> + <a class="code" href="main_8c.html#a4946baeabe139cefb48abe86ae00bda4">USB_HID_KEY_a_A</a>) | <a class="code" href="main_8c.html#aa02590a267536e231cd908ae02f29228">LEFT_SHIFT_BIT</a>;
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;1&#39;</span> &lt;= c &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>)
  {
    <span class="keywordflow">return</span> (c - <span class="charliteral">&#39;1&#39;</span> + <a class="code" href="main_8c.html#a57d866a5f430ca81cf66b77c45934c91">USB_HID_KEY_1</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;0&#39;</span> == c)
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#acea49a32167a274b606539680c275ee2">USB_HID_KEY_0</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;.&#39;</span> == c)
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#a094ee1e9174dc1a90485724bec7aadcb">USB_HID_KEY_DOT</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;,&#39;</span> == c)
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#a53f3aca9a397da6b9007e082970500ef">USB_HID_KEY_COMMA</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;\r&#39;</span> == c)
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#a05a87311083faadbeb4a50aae31295bb">USB_HID_KEY_RETURN</a>);
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39; &#39;</span> == c || <span class="charliteral">&#39;\t&#39;</span> == c)
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#adf8627e6162e1db44517c37a122f0045">USB_HID_KEY_SPACEBAR</a>);
  }
  <span class="keywordflow">else</span>
  {
    <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#adf8627e6162e1db44517c37a122f0045">USB_HID_KEY_SPACEBAR</a>);
  }
}

<span class="keyword">static</span> <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> vtLastKey = 0;

<span class="comment">/* ----------------------- hardware I/O abstraction ------------------------ */</span>

<span class="comment">/* pin assignments:</span>
<span class="comment"> PB0  Key 1</span>
<span class="comment"> PB1  Key 2</span>
<span class="comment"> PB2  Key 3</span>
<span class="comment"> PB3  Key 4</span>
<span class="comment"> PB4  Key 5</span>
<span class="comment"> PB5 Key 6</span>
<span class="comment"></span>
<span class="comment"> PC0  Key 7</span>
<span class="comment"> PC1  Key 8</span>
<span class="comment"> PC2  Key 9</span>
<span class="comment"> PC3  Key 10</span>
<span class="comment"> PC4  Key 11</span>
<span class="comment"> PC5  Key 12</span>
<span class="comment"></span>
<span class="comment"> PD0  USB-</span>
<span class="comment"> PD1  debug tx</span>
<span class="comment"> PD2  USB+ (int0)</span>
<span class="comment"> PD3  Key 13</span>
<span class="comment"> PD4  Key 14</span>
<span class="comment"> PD5  Key 15</span>
<span class="comment"> PD6  Key 16</span>
<span class="comment"> PD7  Key 17</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">void</span> hardwareInit(<span class="keywordtype">void</span>)
{
  <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> i, j;
  PORTD = 0xfa;
  <span class="comment">/* 1111 1010 bin: activate pull-ups except on USB lines */</span>
  DDRD = 0x07;
  <span class="comment">/* 0000 0111 bin: all pins input except USB (-&gt; USB reset) */</span>
  j = 0;
  <span class="keywordflow">while</span> (--j)
  { <span class="comment">/* USB Reset by device only required on Watchdog Reset */</span>
    i = 0;
    <span class="keywordflow">while</span> (--i)
      ; <span class="comment">/* delay &gt;10ms for USB reset */</span>
  }
  DDRD = 0x02;
  <span class="comment">/* 0000 0010 bin: remove USB reset condition */</span>
  <span class="comment">/* configure timer 0 for a rate of 12M/(1024 * 256) = 45.78 Hz (~22ms) */</span>
  TCCR0 = 5;
  <span class="comment">/* timer 0 prescaler: 1024 */</span>
}

<span class="comment">/* ------------------------------------------------------------------------- */</span>

<span class="preprocessor">#define NUM_HARDWARE_KEYS    17</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define NUM_KEYS (NUM_HARDWARE_KEYS + NUM_IR_KEYS)</span>
<span class="preprocessor"></span>
<span class="comment">/* ------------------------------------------------------------------------- */</span>
<span class="comment">/* ----------------------------- USB interface ----------------------------- */</span>
<span class="comment">/* ------------------------------------------------------------------------- */</span>

<span class="keyword">static</span> <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> reportBuffer[2]; <span class="comment">/* buffer for HID reports */</span>
<span class="keyword">static</span> <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> idleRate; <span class="comment">/* in 4 ms units */</span>

<span class="comment">//Names of buttons</span>

<span class="keyword">const</span> <span class="keywordtype">char</span> label00[] <a class="code" href="main_8c.html#a4bc2493b9488cbfb5bf35651b8f5ccee">PROGMEM</a> = <span class="stringliteral">&quot;Press button\n&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label01[] PROGMEM = <span class="stringliteral">&quot;Scan Next Track&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label02[] PROGMEM = <span class="stringliteral">&quot;Scan Previous Track&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label03[] PROGMEM = <span class="stringliteral">&quot;Rewind&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label04[] PROGMEM = <span class="stringliteral">&quot;Play&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label05[] PROGMEM = <span class="stringliteral">&quot;Fast Forward&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label06[] PROGMEM = <span class="stringliteral">&quot;Pause&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label07[] PROGMEM = <span class="stringliteral">&quot;Record&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label08[] PROGMEM = <span class="stringliteral">&quot;Stop&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label09[] PROGMEM = <span class="stringliteral">&quot;Menu&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label10[] PROGMEM = <span class="stringliteral">&quot;Menu Escape&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label11[] PROGMEM = <span class="stringliteral">&quot;Menu Up&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label12[] PROGMEM = <span class="stringliteral">&quot;Menu Down&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label13[] PROGMEM = <span class="stringliteral">&quot;Menu Left&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label14[] PROGMEM = <span class="stringliteral">&quot;Menu Right&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label15[] PROGMEM = <span class="stringliteral">&quot;Menu Pick&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label16[] PROGMEM = <span class="stringliteral">&quot;Menu Value Decrease&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label17[] PROGMEM = <span class="stringliteral">&quot;Menu Value Increase&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label18[] PROGMEM = <span class="stringliteral">&quot;Volume Down&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label19[] PROGMEM = <span class="stringliteral">&quot;Volume Up&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label20[] PROGMEM = <span class="stringliteral">&quot;Mute&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label21[] PROGMEM = <span class="stringliteral">&quot;Channel Decrement&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label22[] PROGMEM = <span class="stringliteral">&quot;Channel Increment&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label23[] PROGMEM = <span class="stringliteral">&quot;Closed Caption Select&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label24[] PROGMEM = <span class="stringliteral">&quot;Closed Caption&quot;</span>;
<span class="keyword">const</span> <span class="keywordtype">char</span> label25[] PROGMEM = <span class="stringliteral">&quot;DONE\n\n&quot;</span>;

PGM_P button_labels[] PROGMEM =
{
  label00,
  label01,
  label02,
  label03,
  label04,
  label05,
  label06,
  label07,
  label08,
  label09,
  label10,
  label11,
  label12,
  label13,
  label14,
  label15,
  label16,
  label17,
  label18,
  label19,
  label20,
  label21,
  label22,
  label23,
  label24,
  label25
};

<span class="preprocessor">#define NUM_IR_KEYS elements_of(button_labels)</span>
<span class="preprocessor"></span>
<span class="keyword">static</span> irrx_code_t ir_codes[<a class="code" href="main_8c.html#ab44962ccd116ade949cc9e1b0909438c">NUM_IR_KEYS</a>];

<span class="keyword">static</span> <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> get_ir_key(irrx_code_t ircode)
{
  <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> i;
  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="main_8c.html#a192d8ca52a5971257154076e5d0321b4">elements_of</a>(ir_codes); i++)
  {
    <span class="keywordflow">if</span> (ircode != <a class="code" href="irrx_8h.html#a9b37b956410016c9791cd56b63666f1f" title="No code received.">IRRX_NO_CODE</a> &amp;&amp; ir_codes[i] == ircode)
      <span class="keywordflow">return</span> i + 1;
  }
  <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> clear_ir_codes(<span class="keywordtype">void</span>)
{
  memset(ir_codes, 0, <span class="keyword">sizeof</span>(ir_codes));
}

<span class="keyword">static</span> irrx_code_t ir_code= <a class="code" href="irrx_8h.html#a9b37b956410016c9791cd56b63666f1f" title="No code received.">IRRX_NO_CODE</a>; <span class="comment">//Currently received ir code</span>
<span class="keyword">static</span> <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> ir_key_pressed = 0;

<span class="keyword">enum</span>
{
  <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a> = 0,
  <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04af27abc9ca222c960254b211d99461e2b">ProgramingMode_LAST</a> = <a class="code" href="main_8c.html#ab44962ccd116ade949cc9e1b0909438c">NUM_IR_KEYS</a>

};

<span class="preprocessor">#define ReportDescriptor usbHidReportDescriptor</span>
<span class="preprocessor"></span>
PROGMEM
<span class="preprocessor">#include &quot;<a class="code" href="ir__keyboard__2_8hid_8h.html">ir_keyboard_2.hid.h</a>&quot;</span>

<a class="code" href="main_8c.html#aa7d921cda07f5efb9d08bbd36ee22f1b">STATIC_ASSERT</a>(<span class="keyword">sizeof</span>(<a class="code" href="usbdrv_8h.html#a37718d9af25fd62f30b25e057468e39b">usbHidReportDescriptor</a>) == <a class="code" href="usbconfig_8h.html#a47d9bef5c10a1b9ba917eca583d2abc9">USB_CFG_HID_REPORT_DESCRIPTOR_LENGTH</a>);

<span class="keyword">static</span> <span class="keywordtype">void</span> print_button_label(uint8_t programming_mode_type)
{
  <span class="comment">//This code from the avrlibc FAQ:</span>
  PGM_P p;
  memcpy_P(&amp;p, &amp;button_labels[programming_mode_type], <span class="keyword">sizeof</span>(PGM_P));
  fprintf_P(stdout,p);
}

<span class="keyword">typedef</span> <span class="keyword">enum</span>
{
  <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384ea5ccd40b7ebdad0fa141830e03d29dd46">report_id_none</a> = 0,
  <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaa1297ee64a181eef334e50aaa88e8a5a">report_id_irremote</a> = 1,
  <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaf94c3c43a4d7295e2a888777fcfc4c87">report_id_virtualkeyboard</a> = 2
} <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384e">report_id_t</a>;

<span class="keyword">static</span> <span class="keywordtype">void</span> buildReport(<a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384e">report_id_t</a> <span class="keywordtype">id</span>, <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> irkey, <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> vtLastKey)
{
  reportBuffer[0] = id;
  <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaa1297ee64a181eef334e50aaa88e8a5a">report_id_irremote</a>)
  {
    reportBuffer[1] = irkey;
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaf94c3c43a4d7295e2a888777fcfc4c87">report_id_virtualkeyboard</a>)
  {
    reportBuffer[1] = vtLastKey;
  }
}

<a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> <a class="code" href="main_8c.html#ae6f351eca7bf6fb1251f9a478cbae2b0">usbFunctionSetup</a>(<a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> data[8])
{
  <a class="code" href="structusbRequest.html">usbRequest_t</a>* rq = (<span class="keywordtype">void</span> *)data;
  <a class="code" href="usbdrv_8c.html#a5f78c8584830588b8c0c8f2a27772f8e">usbMsgPtr</a> = reportBuffer;
  <span class="keywordflow">if</span>((rq-&gt;<a class="code" href="structusbRequest.html#a05c2e0d9ac30dce558bcd69a692314c0">bmRequestType</a> &amp; <a class="code" href="usbdrv_8h.html#aef7b9c4cc4266e79c677fd42e2abb40e">USBRQ_TYPE_MASK</a>) == <a class="code" href="usbdrv_8h.html#a5c5f92099964ea08cc8cf0bccb8ca4ed">USBRQ_TYPE_CLASS</a>)
  {
    <span class="comment">/* class request type */</span>
    <span class="keywordflow">if</span>(rq-&gt;<a class="code" href="structusbRequest.html#a34c18b1dd0af60774cac48b176220c2c">bRequest</a> == <a class="code" href="usbdrv_8h.html#ab0c796905d6a7d0bfc605f8c3e252437">USBRQ_HID_GET_REPORT</a>)
    {
      <span class="comment">/* wValue: ReportType (highbyte), ReportID (lowbyte) */</span>
      <span class="comment">/* we only have one report type, so don&#39;t look at wValue */</span>
      buildReport(rq-&gt;<a class="code" href="structusbRequest.html#ab3f8687bb757c53ed03c3ce4310dc5c5">wValue</a>.<a class="code" href="unionusbWord.html#a3efd0ec82e53de09193e9de269434334">bytes</a>[0],ir_key_pressed,vtLastKey);
      <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(reportBuffer);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rq-&gt;<a class="code" href="structusbRequest.html#a34c18b1dd0af60774cac48b176220c2c">bRequest</a> == <a class="code" href="usbdrv_8h.html#aebf7c3254b56413d7679b89bb99e144c">USBRQ_HID_GET_IDLE</a>)
    {
      <a class="code" href="usbdrv_8c.html#a5f78c8584830588b8c0c8f2a27772f8e">usbMsgPtr</a> = &amp;idleRate;
      <span class="keywordflow">return</span> 1;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rq-&gt;<a class="code" href="structusbRequest.html#a34c18b1dd0af60774cac48b176220c2c">bRequest</a> == <a class="code" href="usbdrv_8h.html#a0d7b2ebb28c23a8bd2fb4a630b85ad71">USBRQ_HID_SET_IDLE</a>)
    {
      idleRate = rq-&gt;<a class="code" href="structusbRequest.html#ab3f8687bb757c53ed03c3ce4310dc5c5">wValue</a>.<a class="code" href="unionusbWord.html#a3efd0ec82e53de09193e9de269434334">bytes</a>[1];
    }
  }
  <span class="keywordflow">else</span>
  {
    <span class="comment">/* no vendor specific requests implemented */</span>
  }
  <span class="keywordflow">return</span> 0;
}

<span class="comment">/* ------------------------------------------------------------------------- */</span>

<span class="preprocessor">#define IR_TIMER_TIMEOUT 10 //10 x 22ms</span>
<span class="preprocessor"></span><span class="preprocessor">#define BLINK_TIMER_TIMEOUT 30 //5 x 22ms</span>
<span class="preprocessor"></span>
<span class="keywordtype">int</span> <a class="code" href="main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)
{
  <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> key = 0;
  <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> lastKey = 0;
  <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384e">report_id_t</a> keyDidChange = <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384ea5ccd40b7ebdad0fa141830e03d29dd46">report_id_none</a>;
  <a class="code" href="oddebug_8h.html#aa8ddf20cdd716b652e76e23e5e700893">uchar</a> idleCounter = 0;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> virtual_keyboard_timer = 0;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ir_timer=0;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> programming_mode_type = 0;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blink_timer=0;
  irrx_code_t last_ir_code = 0;
  <a class="code" href="usbdrv_8h.html#a82287e0a9f6403a674aae635f4c9ce37">usbDeviceDisconnect</a>();
  wdt_enable(WDTO_2S);
    hardwareInit();<a class="code" href="oddebug_8h.html#a76be8d89e4e969ce40a7441dd4d99e80">odDebugInit</a>();
  <a class="code" href="usbdrv_8c.html#a5672a0c07f0f8e93bde4579d278e6307">usbInit</a>();
  <a class="code" href="irrx_8h.html#a67846545c3fb744f6106295133d44586">irrx_init</a>();
  <a class="code" href="irrx_8h.html#acefc681e50139ef6fecefc69f99644d8">irrx_power_on</a>();
  <a class="code" href="main_8c.html#a7e787ad0abe6e286eedf5f5ef2f2197b">LED_RED_INIT</a>();
  <a class="code" href="main_8c.html#a80ba70ad8af2e269976f4460a3414dd9">LED_GREEN_INIT</a>();
  <a class="code" href="main_8c.html#a550fbfbb0db187844ade560690c7fa5f">SWITCH_PGM_INIT</a>();
  sei();
  <a class="code" href="oddebug_8h.html#a1b3ae5f24b3863d451c3648fa2ff57be">DBG1</a>(0x00, 0, 0);
  eeprom_read_block(&amp;ir_codes, 0, <span class="keyword">sizeof</span>(ir_codes));

  stdout = &amp;virtual_keyboard_file_io;
  <a class="code" href="uart__io_8c.html#ad3958bec837802b46366b1354c8c666c">uart_io_init</a>();
  <a class="code" href="usbdrv_8h.html#a475d8622b0e0b64b65312970940c600e">usbDeviceConnect</a>();
  <span class="comment">/* main event loop */</span>
  <span class="keywordflow">for</span> (;;)
  {
    <span class="comment">//Watchdog</span>
    wdt_reset();

    <span class="comment">//usb</span>
<span class="comment"></span>    <a class="code" href="usbdrv_8c.html#a188162c29eb62ffbd2d33763d20e12b4">usbPoll</a>();

    <span class="comment">//IR Remote</span>
<span class="comment"></span>    ir_code = <a class="code" href="irrx_8h.html#aefd7d3a37ea0c9c112bbb819045fcea4">irrx_getcode</a>();
    <span class="keywordflow">if</span> (ir_code != last_ir_code)
    {
      last_ir_code = ir_code;
      ir_key_pressed = get_ir_key(ir_code);
      <span class="keywordflow">if</span> (ir_key_pressed != 0)
      {
        <a class="code" href="main_8c.html#a95ee068e1e61fe45d00e66a1bfee85d1">LED_RED_ON</a>();
      }
      <span class="keywordflow">else</span>
      {
        <a class="code" href="main_8c.html#a327a94a460a470f29977db858d8074e1">LED_RED_OFF</a>();
      }
      <span class="keywordflow">if</span> (programming_mode_type &gt; <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a>)
      {
        <span class="keywordflow">if</span> (ir_code != <a class="code" href="irrx_8h.html#a9b37b956410016c9791cd56b63666f1f" title="No code received.">IRRX_NO_CODE</a>)
        {
          <span class="keywordflow">if</span> (ir_key_pressed == 0) <span class="comment">//Is key already programmed?</span>
          {
            <span class="comment">//No,</span>
            ir_codes[programming_mode_type - 1] = ir_code;
            fprintf_P(stdout,PSTR(<span class="stringliteral">&quot; 0x%04x\n&quot;</span>),ir_code);
            programming_mode_type++;
            print_button_label(programming_mode_type);
            <span class="keywordflow">if</span> (programming_mode_type &gt;= <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04af27abc9ca222c960254b211d99461e2b">ProgramingMode_LAST</a>)
            {
              eeprom_write_block(&amp;ir_codes, 0, <span class="keyword">sizeof</span>(ir_codes));
              programming_mode_type = <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a>;
            }
          }
          <span class="keywordflow">else</span>
          {
            <span class="comment">//Yes</span>
            fprintf_P(stdout,PSTR(<span class="stringliteral">&quot;\n&quot;</span>));
            print_button_label(programming_mode_type);
          }
        }
      }
      <span class="keywordflow">else</span>
      {
        <span class="comment">//fprintf_P(stdout,PSTR(&quot;A&quot;));</span>
        keyDidChange = <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaa1297ee64a181eef334e50aaa88e8a5a">report_id_irremote</a>;
      }
    }

    <span class="comment">//Key presses</span>
<span class="comment"></span>    key = <a class="code" href="main_8c.html#a023283967eacb7889ae3819ba47cb2f8">SWITCH_PGM_IS_PRESSED</a>();
    <span class="keywordflow">if</span> (lastKey != key)
    {
      <span class="keywordflow">if</span> (key)
      {
        <span class="keywordflow">if</span> (programming_mode_type == <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a>)
        {
          clear_ir_codes();
          fprintf_P(stdout,PSTR(<span class="stringliteral">&quot;\nIR Keyboard (C) 2007 jorgen.birkler@gmail.com\n&quot;</span>));
          print_button_label(programming_mode_type);
          programming_mode_type++;
          print_button_label(programming_mode_type);
        }
        <span class="keywordflow">else</span>
        {
          programming_mode_type = <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a>;
          <a class="code" href="main_8c.html#a327a94a460a470f29977db858d8074e1">LED_RED_OFF</a>();
        }
      }
      lastKey = key;
    }
    <span class="comment">//Virtual keyboard (printf)</span>
<span class="comment"></span>    <span class="keywordflow">if</span> (virtual_keyboard_buffer_not_empty() &amp;&amp; virtual_keyboard_timer == 0)
    {
      virtual_keyboard_timer = 3;
    }

    <span class="comment">//USB interrupt</span>
<span class="comment"></span>    <span class="keywordflow">if</span> (keyDidChange &amp;&amp; <a class="code" href="usbdrv_8h.html#a1f6b221fb650a7575d4937e37956181d">usbInterruptIsReady</a>())
    {
      <span class="comment">/* use last key and not current key status in order to avoid lost changes in key status. */</span>
      buildReport(keyDidChange, ir_key_pressed, vtLastKey);
      <a class="code" href="usbdrv_8h.html#aafa474a799eed02d362bfdfb8a36602c">usbSetInterrupt</a>(reportBuffer, <span class="keyword">sizeof</span>(reportBuffer));
      keyDidChange = 0;
    }

    <span class="comment">//Timer</span>
<span class="comment"></span>
    <span class="keywordflow">if</span> (TIFR &amp; _BV(TOV0))
    {
      <span class="comment">/* 22 ms timer */</span>
      TIFR = 1&lt;&lt;TOV0;
      <span class="keywordflow">if</span> (programming_mode_type != <a class="code" href="main_8c.html#abc6126af1d45847bc59afa0aa3216b04abb79a6c34b3135862fdfb5192a9e1591">ProgramingMode_Not</a>)
      {
        <span class="keywordflow">if</span> (blink_timer == 0)
        {
          <a class="code" href="main_8c.html#a5bbf7f30820f080616be89266fbcf129">LED_RED_CHANGE</a>();
          blink_timer = <a class="code" href="main_8c.html#a950e6c73a7a60c02d5ddf48d538ca2c1">BLINK_TIMER_TIMEOUT</a>;
        }
        blink_timer--;
      }
      <span class="keywordflow">if</span> (virtual_keyboard_timer &gt; 0)
      {
        virtual_keyboard_timer--;
        <span class="keywordflow">if</span> (virtual_keyboard_timer == 1)
        {
          vtLastKey = 0;
          keyDidChange = <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaf94c3c43a4d7295e2a888777fcfc4c87">report_id_virtualkeyboard</a>;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (virtual_keyboard_timer == 0)
        {
          keyDidChange = <a class="code" href="main_8c.html#adc4a49de71d98fba3ecc94fb4023384eaf94c3c43a4d7295e2a888777fcfc4c87">report_id_virtualkeyboard</a>;
          vtLastKey
              = virtual_keyboard_translate_to_hid(virtual_keyboard_iogetchar());
          <span class="keywordflow">if</span> (vtLastKey != 0)
          {
            virtual_keyboard_timer = 2;
          }
        }
      }

      <span class="keywordflow">if</span> (ir_timer &gt; 0)
      {
        ir_timer--;
        <span class="keywordflow">if</span> (ir_timer == 0)
        {
          <a class="code" href="main_8c.html#a327a94a460a470f29977db858d8074e1">LED_RED_OFF</a>();
          <a class="code" href="main_8c.html#a644339948c77e66e185ba6fc33501f39">LED_GREEN_OFF</a>();
          ir_key_pressed = 0;
          ir_code = <a class="code" href="irrx_8h.html#a9b37b956410016c9791cd56b63666f1f" title="No code received.">IRRX_NO_CODE</a>;
          keyDidChange = 1;
        }
      }
      <span class="keywordflow">if</span> (idleRate != 0)
      {
        <span class="keywordflow">if</span> (idleCounter &gt; 4)
        {
          idleCounter -= 5; <span class="comment">/* 22 ms in units of 4 ms */</span>
        }
        <span class="keywordflow">else</span>
        {
          idleCounter = idleRate;
          <span class="comment">//keyDidChange = 1;</span>
        }
      }
    }
  }
  <span class="keywordflow">return</span> 0;
}

<span class="comment">/* ------------------------------------------------------------------------- */</span>

</pre></div> </div>
<hr class="footer"/><address style="text-align: right;"><small>
Generated on Mon Jun 7 18:44:13 2010 for USB IR HID Device by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen.org</a> 1.6.3</small></address>
</body>
</html>
